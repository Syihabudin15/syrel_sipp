import moment from "moment";
import { IDocument } from "@/libs/IInterfaces";
import { Header } from "../utils";
import { IDRFormat } from "@/components/utils/PembiayaanUtil";

moment.locale("id");

const generateSD = (record: IDocument) => {
  const html = `
  <!doctype html>
  <html>
    <head>
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width,initial-scale=1" />
      <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
      <style>
        @page {
          size: A4;
          margin: 15mm;
        }

        html, body {
          height: 100%;
          font-family: Cambria, Georgia, 'Times New Roman', Times, serif;
          font-size: 14px;
          text-align: justify;
        }

        /* Pemisah halaman */
        .page-break {
          page-break-before: always;
          break-before: page;
          display: block;
          height: 0;
          border: none;
        }
          @media print {
            .page {
              position: relative;
              min-height: 95vh;    /* atau height A4 jika untuk print */
              padding-top: 80px;    /* ruang untuk header */
              page-break-after: always;
            }
    
            .page .page-header {
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              padding: 10px;
              text-align: center;
              background: white;
              border-bottom: 1px solid #ccc;
            }
          }
      </style>
    </head>
    <body class="bg-white text-gray-800 leading-relaxed p-4 max-w-200">

    <div class="page" style="font-size: 12px;">
      ${Header("PENYERAHAN BERKAS PEMBIAYAAN PENSIUN", record.id, undefined, process.env.NEXT_PUBLIC_APP_LOGO, record.Sumdan.logo)}

      <div class="my-4">
        <div class="flex gap-3">
          <p class="w-44">No</p>
          <p class="w-4">:</p>
          <p class="flex-1">${record.id}</p>
        </div>
        <div class="flex gap-3">
          <p class="w-44">Lampiran</p>
          <p class="w-4">:</p>
          <p class="flex-1">-</p>
        </div>
        <div class="flex gap-3">
          <p class="w-44">Perihal</p>
          <p class="w-4">:</p>
          <p class="flex-1">Penyerahan Berkas Pembiayaan Pensiun</p>
        </div>
      </div>

      <div class="mt-4">
        <p>Kepada Yth</p>
        <p class="font-bold">Direktur ${record.Sumdan.name}</p>
        <p>Di tempat</p>
      </div>
      <div class="mt-2">
        <p>Sehubungan dengan telah diterimanya dana dropping pembiayaan pensiun dari ${record.Sumdan.name} ke rekening Koperasi, maka dari itu sebagai bagian dari administrasi dan realisasi pembiayaan, bersama surat ini kami kirimkan dokumen permohonan pembiayaan pensiun atas debitur sebagai berikut :</p>
        
        <div class="mt-10">
          <table class="w-full border-collapse border border-gray-400 border-dashed text-sm mb-4">
            <thead>
              <tr class="bg-gray-200">
                <th class="border border-gray-400 border-dashed p-1">NO</th>
                <th class="border border-gray-400 border-dashed p-1">Debitur</th>
                <th class="border border-gray-400 border-dashed p-1">Nomor SKEP</th>
                <th class="border border-gray-400 border-dashed p-1">Nomor PK</th>
                <th class="border border-gray-400 border-dashed p-1">Plafond</th>
              </tr>
            </thead>
            <tbody>
              ${record.Dapem.map(
                (r, i) => `
                <tr>
                  <td class="border border-gray-400 border-dashed p-1 text-center">${i + 1}</td>
                  <td class="border border-gray-400 border-dashed p-1">
                    <div>
                      ${r.Debitur.fullname}
                    </div>
                    <div class="text-xs opacity-70">
                      ${r.Debitur.nopen}
                    </div>
                  </td>
                  <td class="border border-gray-400 border-dashed p-1 ">${r.Debitur.no_skep}</td>
                  <td class="border border-gray-400 border-dashed p-1 ">${r.no_contract}</td>
                  <td class="border border-gray-400 border-dashed p-1 text-right">${IDRFormat(r.plafond)}</td>
                </tr>
              `,
              ).join("")}
            </tbody>
            <tfoot>
              <tr class="bg-gray-100 font-semibold italic">
                <td
                  colspan="4"
                  class="border border-gray-400 p-2 text-center border-dashed"
                >
                  JUMLAH
                </td>
                <td class="border border-gray-400 p-2 text-right border-dashed">
                  ${IDRFormat(record.Dapem.reduce((acc, curr) => acc + curr.plafond, 0))}
                </td>
              </tr>
            </tfoot>
          </table>
        </div>

        <p>Demikian surat ini kami sampaikan sebagai bukti konfirmasi penerimaan dana dan kelengkapan administrasi realisasi pembiayaan. Atas kerja sama yang baik, kami ucapkan terima kasih.</p>
      </div>

      <div class="mt-20 flex justify-end">
        <div class="w-96 text-center">
          <p>${process.env.NEXT_PUBLIC_APP_COMPANY_CITY}, ${moment(record.created_at).format("DD-MM-YYYY")}</p>
          <p>${process.env.NEXT_PUBLIC_APP_COMPANY_NAME?.toUpperCase()}</p>
          <div class="h-40"></div>
          <p class="undeline">${process.env.NEXT_PUBLIC_APP_PB_NAME}</p>
          <p>${process.env.NEXT_PUBLIC_APP_PB_POSITION}</p>
        </div>
      </div>

    </div>

    </body>
  </html>
  `;

  return html;
};

export const printSDStandar = (record: IDocument) => {
  const htmlContent = generateSD(record);

  const w = window.open("", "_blank", "width=900,height=1000");
  if (!w) {
    alert("Popup diblokir. Mohon izinkan popup dari situs ini.");
    return;
  }

  w.document.open();
  w.document.write(htmlContent);
  w.document.close();
  w.onload = function () {
    setTimeout(() => {
      w.print();
    }, 200);
  };
};
